# /*
# |    Protect your secrets, protect your sensitive data.
# :    Explore VMware Secrets Manager docs at https://vsecm.com/
# </
# <>/  keep your secrets... secret
# >/
# <>/' Copyright 2023-present VMware Secrets Manager contributors.
# >/'  SPDX-License-Identifier: BSD-2-Clause
# */

# ConfigMap containing the SPIRE server configuration.
apiVersion: v1
kind: ConfigMap
metadata:
  name: spire-server
  namespace: {{ .Values.global.spire.serverNamespace }}
  labels:
    {{- include "spire.labels" . | nindent 4 }}
data:
  server.conf: |
    {
      "server": {
        "audit_log_enabled": true,
        "bind_address": "0.0.0.0",
        "bind_port": {{ .Values.spireServer.containerPort}},
        "trust_domain": {{ .Values.global.spire.trustDomain | quote }},
        "data_dir": {{ .Values.spireServer.dataDir | quote }},
        "log_level": {{ .Values.global.spire.logLevel | quote }},
{{- if .Values.global.spire.federationEnabled }}
        "federation": {
          "bundle_endpoint": {
            "address": "0.0.0.0",
            "port": 8443
          }
        },
{{- end }}
{{- if .Values.experimental.eventsBasedCache }}
        "experimental": {
          "events_based_cache": true
        },
{{- end }}
        "ca_key_type": "rsa-2048",
        "ca_subject": [
          {
            "common_name": {{ .Values.global.spire.caCommonName | quote }},
            "country": [
                {{ .Values.global.spire.caCountry | quote }}
            ],
            "organization": [
              {{ .Values.global.spire.caOrganization | quote }}
            ]
          }
        ]
      },
      "health_checks": {
        "bind_address": "0.0.0.0",
        "bind_port": "8080",
        "listener_enabled": true,
        "live_path": "/live",
        "ready_path": "/ready"
      },
      "plugins": {
        "DataStore": [
          {
            "sql": {
              "plugin_data": {
                "database_type": "sqlite3",
                "connection_string": "{{ .Values.spireServer.dataDir }}/datastore.sqlite3"
              }
            }
          }
        ],
        "NodeAttestor": [
          {
            "k8s_psat": {
              "plugin_data": {
                "clusters": [
                  {
                    "vsecm-cluster": {
                      "allowed_node_label_keys": [],
                      "allowed_pod_label_keys": [],
                      "audience": [
                        "spire-server"
                      ],
                      "service_account_allow_list": [
                        "{{ .Values.global.spire.namespace }}:spire-agent"
                      ]
                    }
                  }
                ]
              }
            }
          }
        ],
        "KeyManager": [
          {
            "disk": {
              "plugin_data": {
                "keys_path": "{{ .Values.spireServer.dataDir }}/keys.json"
              }
            }
          }
        ],
        "Notifier": [
          {
            "k8sbundle": {
              "plugin_data": {
                "config_map": "spire-bundle",
                "namespace": "{{ .Values.global.spire.namespace }}"
              }
            }
          }
        ]
      }
    }
